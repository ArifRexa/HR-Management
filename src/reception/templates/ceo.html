{% extends "admin/change_list.html" %}
{% load static %}

{% block content_title %}
    <div style="width: 100%">   
        <h1>CEO Waiting List<span style="float: right;font-size: 20px;"><a target="_blank" href="{{ main_domain }}/ceo-appointment/">Show in Web</a></span></h1><br><br>
    </div>
{% endblock %}

{% block content %}
    {% if request.user.is_superuser %}
    <label style="font-weight: bold;">Select CEO Status:</label>
    <div style="display: flex; align-items: center; gap: 20px; margin: 10px 0px;" class="flex align-items-center flex-wrap">
       
        {% for status in ceo_status %}
        <div class="form-check form-check-inline mr-3">
            <input type="radio" class="form-check-input" id="status_{{ status.id }}" name="ceo_status" 
                   value="{{ status.status_name }}" onchange="updateStatus(this)">
            <label class="form-check-label" for="status_{{ status.id }}">{{ status.status_name }}</label>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {{ block.super }}
{% endblock %}

{% block extrahead %}
<link rel="icon" id="med">
<script>
    // Function to update the selected status and save it in localStorage
    function updateStatus(element) {
        const selectedStatus = element.value;
        localStorage.setItem('selectedCEOStatus', selectedStatus);

        const csrfToken = '{{ csrf_token }}';

        fetch("{% url 'update_ceo_status' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({ "current_status": selectedStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Status updated successfully
            } else {
                alert("Failed to update status.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Set previously selected CEO status from localStorage
        const selectedStatus = localStorage.getItem('selectedCEOStatus');
        if (selectedStatus) {
            const radio = document.querySelector(`input[name="ceo_status"][value="${selectedStatus}"]`);
            if (radio) {
                radio.checked = true;
            }
        }

        // Refresh the page every 2 minutes
        setTimeout(function() {
            window.location.reload();
        }, 120000);

        function fetchPendingReceptionCount() {
            // AJAX GET request to fetch pending count
            fetch("{% url 'pending_waiting_count' %}", {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest' // Recognized as AJAX
                }
            })
            .then(response => response.json())
            .then(data => {
                const pendingCount = data.pending_count;
                const hasPermission = data.has_perm;

                const titleElement = document.getElementsByTagName('title')[0];
                const currentTitle = titleElement.textContent.trim();

                const iconElement = document.getElementById('med');
                if (pendingCount && pendingCount > 0 && hasPermission) {
                    titleElement.textContent = `(${pendingCount}) ${currentTitle}`;
                    iconElement.setAttribute("href", "https://mw-hr.sgp1.digitaloceanspaces.com/media/public_image/dfdfd.png");

                    const savedStatus = localStorage.getItem('notificationStatus');
                    if (savedStatus === 'enabled') {
                        const audio = new Audio("{% static 'audio/reception-notification.mp3' %}");
                        audio.play().then(() => {
                            console.log('Audio playing');
                        }).catch((error) => {
                            console.error('Audio playback failed:', error);
                        });
                    }
                } else {
                    iconElement.setAttribute("href", "https://mw-hr.sgp1.digitaloceanspaces.com/media/public_image/Logo_MW.png");
                    titleElement.textContent = currentTitle;
                }
            })
            .catch(error => {
                console.error("Error fetching pending reception count:", error);
            });
        }

        // Call the function when the page loads
        fetchPendingReceptionCount();
    });
</script>
{% endblock %}
