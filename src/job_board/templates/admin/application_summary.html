{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
{{ block.super }}
<style>
    .summary-form {
        padding: 20px;
        margin: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .checkbox-item {
        margin-right: 15px;
    }

    #emailResults {
        margin-top: 20px;
        padding: 10px;
        /*background: #f9f9f9;*/
    }
    .default {
        background-color: #372d9f; /* Green background */
        border: none;               /* Remove default border */
        color: white;               /* White text */
        padding: 10px 10px;         /* Padding for size */
        text-align: center;         /* Center text */
        text-decoration: none;      /* Remove underline */
        display: inline-block;      /* Inline block for flexibility */
        font-size: 16px;            /* Set font size */
        border-radius: 5px;         /* Rounded corners */
        cursor: pointer;            /* Pointer on hover */
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .default:hover {
        background-color: #1f246e;  /* Darker green on hover */
        transform: translateY(-2px); /* Slight raise effect */
    }

    .default:active {
        background-color: #3e8e41;  /* Even darker green on click */
        transform: translateY(1px);  /* Button depress effect */
    }

    .default:disabled {
        background-color: #cccccc;  /* Greyed out for disabled */
        cursor: not-allowed;
    }

</style>
{% endblock %}

{% block content %}
<div class="summary-form">
    <form id="summaryForm" method="post">
        {% csrf_token %}

        <div class="form-group">
            <label for="job">Select Job:</label>
            <select name="job" id="job" required>
                <option value="">---------</option>
                {% for job in jobs %}
                <option value="{{ job.id }}">{{ job.title }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Select Years:</label>
            <div class="checkbox-group" id="yearCheckboxes">
                {% for year in years %}
                <div class="checkbox-item">
                    <input type="checkbox" name="years" value="{{ year }}" id="year{{ year }}">
                    <label for="year{{ year }}">{{ year }}</label>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="form-group" id="monthContainer" style="display: none;">
            <label>Select Months:</label>
            <div class="checkbox-group" id="monthCheckboxes"></div>
        </div>
    </form>

    <div id="candidateCount" style="display: none;" class="candidate-count"></div>
    <div id="emailActions" style="display: none; margin-top: 20px;">
        <button id="sendEmailsBtn" class="button">Send Emails to Selected Candidates</button>
        <div id="emailStatus"></div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('summaryForm');
        const yearCheckboxes = document.querySelectorAll('input[name="years"]');
        const monthContainer = document.getElementById('monthContainer');
        const monthCheckboxes = document.getElementById('monthCheckboxes');
        const jobSelect = document.getElementById('job');
        const candidateCount = document.getElementById('candidateCount');
        const emailActions = document.getElementById('emailActions');

        async function updateMonths() {
            const selectedYears = Array.from(yearCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);

            if (selectedYears.length > 0 && jobSelect.value) {
                try {
                    const response = await fetch(`{% url 'get_months' %}?job=${jobSelect.value}&years=${selectedYears.join(',')}`);
                    const data = await response.json();

                    monthContainer.style.display = 'block';
                    monthCheckboxes.innerHTML = data.months.map(month => `
                        <div class="checkbox-item">
                            <input type="checkbox" name="months" value="${month.month}" id="month${month.month}" onchange="checkSelectedMonths()">
                            <label for="month${month.month}">${month.name} (${month.count})</label>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error fetching months:', error);
                }
            } else {
                monthContainer.style.display = 'none';
                candidateCount.style.display = 'none';
                emailActions.style.display = 'none';
            }
        }

        // Function to check selected months and update display
        async function checkSelectedMonths() {
            const selectedMonths = Array.from(document.querySelectorAll('input[name="months"]:checked'))
                    .map(cb => cb.value);

            if (selectedMonths.length > 0) {
                const formData = new FormData(form);
                try {
                    const response = await fetch('{% url "get_emails" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    });

                    const data = await response.json();
                    candidateCount.innerHTML = `Total Candidates Selected: ${data.total_candidates}`;
                    candidateCount.style.display = 'block';
                    emailActions.style.display = 'block';
                    window.selectedEmails = data.emails;
                } catch (error) {
                    console.error('Error:', error);
                }
            } else {
                candidateCount.style.display = 'none';
                emailActions.style.display = 'none';
            }
        }

        // Add event listeners
        jobSelect.addEventListener('change', updateMonths);
        yearCheckboxes.forEach(cb => cb.addEventListener('change', updateMonths));
        document.addEventListener('change', function (e) {
            if (e.target.matches('input[name="months"]')) {
                checkSelectedMonths();
            }
        });

        // Send emails button handler
        document.getElementById('sendEmailsBtn').addEventListener('click', async function () {
            if (!window.selectedEmails || window.selectedEmails.length === 0) {
                alert('No emails selected!');
                return;
            }

            if (!confirm(`Are you sure you want to send emails to ${window.selectedEmails.length} recipients?`)) {
                return;
            }

            const statusDiv = document.getElementById('emailStatus');
            statusDiv.innerHTML = 'Sending emails...';

            try {
                const jobId = document.getElementById('job').value;
                const data = {
                    emails: window.selectedEmails,
                    job_id: jobId
                };

                const response = await fetch('{% url "send_bulk_emails" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(data)
                });

                const responseData = await response.json();

                if (responseData.status === 'success') {
                    statusDiv.innerHTML = `<div class="success">${responseData.message}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="error">Error: ${responseData.message}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `<div class="error">Error sending emails: ${error.message}</div>`;
            }
        });
    });
</script>
{% endblock %}
