{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="container">
    <h2>Application Summary</h2>
    <form method="post" id="summaryForm">
        {% csrf_token %}

        <!-- Job Selection -->
        <div class="form-group">
            <label for="job">Select Job:</label>
            <select name="job" id="job" required>
                <option value="">Select a job</option>
                {% for job in jobs %}
                <option value="{{ job.id }}">{{ job.title }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Year Selection -->
        <div class="form-group" id="yearCheckboxes">
            <label>Select Years:</label>
            {% for year in years %}
            <div>
                <input type="checkbox" name="years" value="{{ year }}" id="year{{ year }}">
                <label for="year{{ year }}">{{ year }}</label>
            </div>
            {% endfor %}
        </div>

        <!-- Month Selection (initially hidden) -->
        <div class="form-group" id="monthContainer" style="display: none;">
            <label>Select Months:</label>
            <div id="monthCheckboxes"></div>
        </div>

        <button type="submit" class="button">Get Emails</button>
    </form>

    <!-- Results Section -->
    <div id="results" style="margin-top: 20px;"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('summaryForm');
        const yearCheckboxes = document.querySelectorAll('input[name="years"]');
        const monthContainer = document.getElementById('monthContainer');
        const monthCheckboxes = document.getElementById('monthCheckboxes');
        const jobSelect = document.getElementById('job');

        // When years are selected/deselected
        yearCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', async function () {
                const selectedYears = Array.from(yearCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                if (selectedYears.length > 0 && jobSelect.value) {
                    const response = await fetch(`/admin/job_board/get-months/?job=${jobSelect.value}&years=${selectedYears.join(',')}`);
                    const data = await response.json();

                    // Display months with application counts
                    monthContainer.style.display = 'block';
                    monthCheckboxes.innerHTML = data.months.map(month => `
                    <div>
                        <input type="checkbox" name="months" value="${month.month}" id="month${month.month}">
                        <label for="month${month.month}">${month.name} (${month.count} applications)</label>
                    </div>
                `).join('');
                } else {
                    monthContainer.style.display = 'none';
                }
            });
        });

        // Form submission
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(form);
            const response = await fetch('/admin/job_board/get-emails/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();
            document.getElementById('results').innerHTML = `
            <h3>Results:</h3>
            <p>Total Candidates: ${data.total_candidates}</p>
            <p>Emails: ${data.emails.join(', ')}</p>
        `;
        });
    });
</script>

<style>
    .container {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }
</style>
{% endblock %}