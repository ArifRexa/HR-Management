{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list employee_helper %}
{% load employee_helper %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static "admin/css/changelists.css" %}">
  {% if cl.formset %}
    <link rel="stylesheet" href="{% static "admin/css/forms.css" %}">
  {% endif %}
  {% if cl.formset or action_form %}
    <script src="{% url 'admin:jsi18n' %}"></script>
  {% endif %}
  {{ media.css }}
  {% if not actions_on_top and not actions_on_bottom %}
    <style>
      #changelist table thead th:first-child {width: inherit}
      #tpm-extra-data{
        width: 90%;
      }
    </style>
  {% endif %}
{% endblock %}

{% block extrahead %}
{{ block.super }}
{{ media.js }}
<script src="{% static 'admin/js/filters.js' %}" defer></script>

<script>
  window.addEventListener('load', () => {
  document.getElementById('main').classList.remove('shifted');
});
</script>
{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-list{% endblock %}

{% if not is_popup %}
{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=cl.opts.app_label %}">{{ cl.opts.app_config.verbose_name }}</a>
&rsaquo; {{ cl.opts.verbose_name_plural|capfirst }}
</div>
{% endblock %}
{% endif %}

{% block coltype %}{% endblock %}
<br><br>
{% block content %}
  <br>
  <div id="content-main">
    {% block object-tools %}
    <ul class="object-tools">
        {% block object-tools-items %}
            {% change_list_object_tools %}
        {% endblock %}
    </ul>
{% endblock %}
{% block content_title %}{% endblock %}

    <div class="results" >
        <div style="text-align: center;">
          <b style="font-size: 1em;">All Employees Last 4 Weeks Total: {{ total_expected|floatformat:0 }} 
            ({% if total_actual < total_expected %}<span style="color: red;">{{ total_actual|floatformat:0 }}</span>{% else %}{{ total_actual|floatformat:0 }}{% endif %}) ({{formatted_weekly_sums}})</b>
          <p>Data Presentation: [ Weekly Expected Hour(Last 4 Weeks Hours) || Monthly Expected Hour(Total Last 4 Weeks Hour) ]</p>
          
        </div>
        <br>
        <table id="tpm-extra-data" style="width: 83%;">
            <thead>
            <tr>
                <th scope="col">TPM</th>
                <th scope="col">Employees</th>
                <th scope="col">Projects</th>
                <th scope="col">Clients</th>
            </tr>
            </thead>
            <tbody>

                {% for result in tpm_data %}

                <tr>
                    <td>
                      <span style="font-weight: bold; font-size: 1.5em;">{{ result.tpm }}</span> <br> <br>
                      
                      <b>{{ result.last_week_date_range.0.1|date:"F j" }}: </b>
                      <b>{{ result.get_weekly_expected_hour|floatformat:0 }}({% if result.last_week_hours.0 < result.get_weekly_expected_hour%}<span style="color: red;">{{ result.last_week_hours.0|floatformat:0 }}</span>{% else %}{{ result.last_week_hours.0|floatformat:0 }}{% endif %})</b><br>
                      
                      <b>{{ result.last_week_date_range.1.1|date:"F j" }}: </b>
                      <b>{{ result.get_weekly_expected_hour|floatformat:0 }}({% if result.last_week_hours.1 < result.get_weekly_expected_hour %}<span style="color: red;">{{ result.last_week_hours.1|floatformat:0 }}</span>{% else %}{{ result.last_week_hours.1|floatformat:0 }}{% endif %})</b><br>
                      
                      <b>{{ result.last_week_date_range.2.1|date:"F j" }}: </b>
                      <b>{{ result.get_weekly_expected_hour|floatformat:0 }}({% if result.last_week_hours.2 < result.get_weekly_expected_hour %}<span style="color: red;">{{ result.last_week_hours.2|floatformat:0 }}</span>{% else %}{{ result.last_week_hours.2|floatformat:0 }}{% endif %})</b><br>
                      
                      <b>{{ result.last_week_date_range.3.1|date:"F j" }}: </b>
                      <b>{{ result.get_weekly_expected_hour|floatformat:0 }}({% if result.last_week_hours.3 < result.get_weekly_expected_hour %}<span style="color: red;">{{ result.last_week_hours.3|floatformat:0 }}</span>{% else %}{{ result.last_week_hours.3|floatformat:0 }}{% endif %})</b><br>
                    
                      <br><span style="font-weight: bold; font-size: 1.2em;">
                        <b>Last 4 Weeks:</b> 
                        {{ result.tpm_expected_hour|floatformat:0  }} 
                        <b>
                            {% with total_hours=result.last_week_hours.0|add:result.last_week_hours.1|add:result.last_week_hours.2|add:result.last_week_hours.3 %}
                                {% if total_hours < result.tpm_expected_hour %}
                                    (<span style="color: red;">{{ total_hours|floatformat:0 }}</span>)
                                {% else %}
                                    ({{ total_hours|floatformat:0 }})
                                {% endif %}
                            {% endwith %}
                        </b>
                    </span>
                    <td>
                        <ul>
                          <span style="font-weight: bold; font-size: 1.5em;">{{result.employees|length}}</span>
                          
                          {% for employee in result.employees %}
                          <li>{{ employee }}
                            [ {% widthratio employee.monthly_expected_hours 4 1 %}({% with employee.get_last_four_weeks_totals as totals %}{{ totals.0|safe }}) || {{ employee.monthly_expected_hours|floatformat:0 }} ({% if totals.1 < employee.monthly_expected_hours %}<span style="color: red;">{{ totals.1 }}</span>{% else %}{{ totals.1 }}{% endif %})
                            {% endwith %}] {% if employee.id %} <a href="{% url 'admin:time_hour_graph' employee.id %}" target="_blank" style="display: inline-block; border-radius: 5px; padding: 2px; border: 1px solid #ccc;">ðŸ“ˆ</a> {% endif %}
                          </li>
                          {% endfor %}
                        </ul>
                        
                    </td>
                    <td>
                      <span style="font-weight: bold; font-size: 1.5em; margin-left: 15px;">{{result.projects|length}}</span>
                      <ul>
                        {% for project in result.projects %}
                          <li>
                            {{ project.title }}
                            ({% for hours in result.last_four_project_hours|get_item:project.id %}{{hours|floatformat:0}}{% if not forloop.last %},{% endif %}{% endfor %})
                             {% if project.id %} <a href="{% url 'admin:project_hour_graph' project.id %}" target="_blank">ðŸ“ˆ</a> {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </td>
                    <td>
                      <span style="font-weight: bold; font-size: 1.5em; margin-left: 15px;">{{result.clients|length}}</span>
                        <ul>
                          {% for client in result.clients %}
                          <li>
                            {{ client }}
                            {% if client.id %} <a href="{% url 'admin:client_projects_hour_graph' client.id %}" target="_blank">ðŸ“ˆ</a> {% endif %}
                          </li>
                          {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endfor %}
    
            </tbody>
        </table>
    </div>



    {% if cl.formset and cl.formset.errors %}
        <p class="errornote">
        {% blocktranslate count counter=cl.formset.total_error_count %}Please correct the error below.{% plural %}Please correct the errors below.{% endblocktranslate %}
        </p>
        {{ cl.formset.non_form_errors }}
    {% endif %}
    <div class="module{% if cl.has_filters %} filtered{% endif %}" id="changelist">
      <div class="changelist-form-container">
        {% block search %}{% search_form cl %}{% endblock %}
        {% block date_hierarchy %}{% if cl.date_hierarchy %}{% date_hierarchy cl %}{% endif %}{% endblock %}

        <form id="changelist-form" method="post"{% if cl.formset and cl.formset.is_multipart %} enctype="multipart/form-data"{% endif %} novalidate>{% csrf_token %}
        {% if cl.formset %}
          <div>{{ cl.formset.management_form }}</div>
        {% endif %}

        {% block result_list %}
          {% if action_form and actions_on_top and cl.show_admin_actions %}{% admin_actions %}{% endif %}
          {% result_list cl %}
          {% if action_form and actions_on_bottom and cl.show_admin_actions %}{% admin_actions %}{% endif %}
        {% endblock %}
        {% block pagination %}{% pagination cl %}{% endblock %}
        </form>
      </div>
      {% block filters %}
        {% if cl.has_filters %}
          <nav id="changelist-filter" aria-labelledby="changelist-filter-header">
            <h2 id="changelist-filter-header">{% translate 'Filter' %}</h2>
            {% if cl.is_facets_optional or cl.has_active_filters %}<div id="changelist-filter-extra-actions">
              {% if cl.is_facets_optional %}<h3>
                {% if cl.add_facets %}<a href="{{ cl.remove_facet_link }}" class="hidelink">{% translate "Hide counts" %}</a>
                {% else %}<a href="{{ cl.add_facet_link }}" class="viewlink">{% translate "Show counts" %}</a>{% endif %}
              </h3>{% endif %}
              {% if cl.has_active_filters %}<h3 id="changelist-filter-clear">
                <a href="{{ cl.clear_all_filters_qs }}">&#10006; {% translate "Clear all filters" %}</a>
              </h3>{% endif %}
            </div>{% endif %}
            {% for spec in cl.filter_specs %}{% admin_list_filter cl spec %}{% endfor %}
          </nav>
        {% endif %}
      {% endblock %}
    </div>
  </div>
{% endblock %}