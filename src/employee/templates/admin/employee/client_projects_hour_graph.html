{% extends "admin/base_site.html" %}

{% block title %}
    Clients Project Hours
{% endblock title %}

{% block content %}
    {% load static %}

    <style>
        #main{
            /* min-width: 100%; */
            /* height: 70vh; */
            /* max-height: 80vh; */
            min-height: 70vh;
            min-width: 100%;
        }
        #calendarbox0{
            top: 180px !important;
        }
        #calendarbox1{
            left: 85% !important;
            top: 180px !important;
        }
        #nav-sidebar{
            display: none;
        }
        #toggle-nav-sidebar{
            display: none;
        }
        button {
            outline: none;
            background: white;
            padding: 6px 10px;
            color: #417690;
            border: 1px solid #417690;
            border-radius: 4px;
            font-weight: 400;
            transition: background 0.15s;
            cursor: pointer;
            margin-right: 6px;
        }
        button.active {
            background: #417690;
            border-color: #417690;
            color: white;
            font-weight: 600;
        }
        button.filter-active {
            background: #417690 !important;
            color: white !important;
            border-color: #417690 !important;
            font-weight: 600 !important;
        }
        .content{
            max-width: 100% !important;
        }
    </style>

    <script src="{% url 'js-catalog' %}"></script>
    <script src="{% static 'admin/js/core.js' %}"></script>
    <link rel="stylesheet" href="{% static 'admin/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'admin/css/widgets.css' %}">

    {% block content_title %}{% endblock %}
    <div style="display: flex; justify-content: space-evenly;">
        <div>
            <h1>Clients Project Hours (<strong id="client_name_id"></strong>)</h1>
        </div>
    </div>

    <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div>
            <h1 id="chartTitle"> Total Hours:</h1>
        </div>

        <div>
            <label for="projectSelect" style="margin-right: 6px; font-weight: 600;">Select Project:</label>
            <select id="projectSelect" style="padding:6px 10px; border:1px solid #417690; border-radius:4px; color:#417690; font-weight:500;">
                {% for project_name, _ in chart_data.items %}
                    <option value="{{ project_name }}">{{ project_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <!-- Chart type switch -->
            <button id="barChart" class="active" onclick="changeChartType('bar')">Bar</button>
            <button id="lineChart" onclick="changeChartType('line')">Line</button>
        </div>

        <div>
            <!-- Weekly / Monthly switch -->
            <button id="weeklyBtn" class="active" onclick="changeView('weekly')">Weekly</button>
            <button id="monthlyBtn" onclick="changeView('monthly')">Monthly</button>
        </div>
        <div>
            <form action="" method="get">
                {{ filter_form.media }}
                {{filter_form.date__gte.label_tag }}{{ filter_form.date__gte }}
                {{filter_form.date__lte.label_tag }}{{ filter_form.date__lte }} 
                <!-- <br> -->
                <!-- {{filter_form.total_hour__gte.label_tag }}{{ filter_form.total_hour__gte }} - {{ filter_form.total_hour__lte }} -->
                
                <button type="submit" class="default" id="filter-button-id">Filter</button>
                <button type="button" onclick="window.location.href = window.location.pathname;">
                    Reset
                </button>
            </form>
        </div>
    </div>

    <div id="main">
        <canvas id="hourChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <script>
        const projectData = {{ chart_data|safe }};
        const ctx = document.getElementById('hourChart').getContext('2d');
        const projectSelect = document.getElementById('projectSelect');
        let currentType = 'bar';
        let currentView = 'weekly'; // Default: weekly
        let projects_name = Object.keys(projectData);
        const default_selected_project = "All Projects";
        let currentProject = projectData[default_selected_project] ? default_selected_project : projects_name.find(project_name => project_name !== default_selected_project);
        projectSelect.value = currentProject;

        function labelToDateRange(label, view) {
            /* 1. sanity check */
            if (typeof label !== 'string') return null;

            /* 2. try to parse --------------------------------------------------- */
            const months = { Jan:0, Feb:1, Mar:2, Apr:3, May:4, Jun:5,
                            Jul:6, Aug:7, Sep:8, Oct:9, Nov:10, Dec:11 };

            /* daily / weekly labels come as “DD-Mon-YYYY” */
            let d, m, y;
            if (label.length === 11) {                    // 01-Sep-2025
                const mArr = label.match(/(\d{2})-(\w{3})-(\d{4})/);
                if (!mArr) return null;
                [, d, m, y] = mArr;
            } else {                                      // Sep-2025
                const mArr = label.match(/(\w{3})-(\d{4})/);
                if (!mArr) return null;
                [, m, y] = mArr;
                d = 1;
            }

            /* 3. build the range (same as before) ------------------------------- */
            const refDate = new Date(Date.UTC(y, months[m], d));
            let startDate, endDate;

            
            if (view === 'weekly') {
                startDate = new Date(refDate);
                startDate.setUTCDate(refDate.getUTCDate() - 6);
                endDate   = refDate;
            } else { // monthly
                startDate = new Date(Date.UTC(y, months[m], 1));
                endDate   = new Date(Date.UTC(y, months[m] + 1, 0));
            }

            const pad = n => n.toString().padStart(2, '0');
            const toStr = date =>
                `${date.getUTCFullYear()}-${pad(date.getUTCMonth()+1)}-${pad(date.getUTCDate())}`;

            return { start: toStr(startDate), end: toStr(endDate) };
        }

        function getConfig(type, data) {
            return {
                type: type,
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.label,
                        data: data.data,
                        client_id: data.client_id,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgb(75, 192, 192)',
                            'rgb(255, 99, 132)',
                            'rgb(255, 206, 86)',
                            'rgb(54, 162, 235)',
                            'rgb(153, 102, 255)',
                            'rgb(255, 159, 64)'
                        ],
                        borderWidth: 1,
                        fill: type === 'line' ? true : false,
                        tension: type === 'line' ? 0.3 : 0
                    }]
                },
                options: {
                    // indexAxis: "y",
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            anchor: 'end',        // attach to end (top) of the bar
                            align: 'end',         // align label above the bar
                            // offset: 8,
                            formatter: function(value) {
                                return value.toFixed(1);
                            },
                            font: {
                                weight: 'bold',
                                size: 16
                            },
                            color: "green",
                            listeners: {
                                click: function(context) {
                                    /* 1. get the label and turn it into a date range */
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const range = labelToDateRange(label, currentView);

                                    const client_id = context.chart.data.datasets[0].client_id;
                                    const base = window.location.origin;
                                    if(default_selected_project === currentProject){
                                        // for All projects
                                        qs = new URLSearchParams(
                                            {
                                                project__client__id__exact: client_id,
                                                created_at__date__gte: range.start,
                                                created_at__date__lte: range.end
                                            }
                                        );
                                    }else{
                                        const project_id = projectData[currentProject]["project_id"]
                                        qs = new URLSearchParams(
                                            {
                                                project__id__exact: project_id,
                                                project__client__id__exact: client_id,
                                                created_at__date__gte: range.start,
                                                created_at__date__lte: range.end
                                            }
                                        );
                                    }
                                    
                                    console.log(`${qs}`)
                                    window.open(`${base}/admin/project_management/dailyprojectupdate/?${qs}`, '_blank');
                                },
                                enter: function(context) {
                                    // Change cursor to pointer when hovering over a datalabel
                                    context.chart.canvas.style.cursor = 'pointer';
                                },
                                leave: function(context) {
                                    // Revert cursor to default when leaving a datalabel
                                    context.chart.canvas.style.cursor = 'default';
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            bodyFont: { size: 16 },
                            titleFont: { size: 18 },
                            footerFont: { size: 14 },
                            displayColors: false,
                        },
                        legend: {
                            labels: { font: { size: 14 } }
                        },
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            barThickness: 20,
                            categoryPercentage: 0.9,
                            barPercentage: 0.8,
                        },
                    }
                },
                plugins: [ChartDataLabels],
            };
        }

        function renderChart() {
            const selected = projectData[currentProject][currentView];
            if (!selected) return;

            document.getElementById('chartTitle').textContent = 
                `Total Hours (${currentView}): ${selected.total_hour.toFixed(2)}`;
            document.getElementById('client_name_id').textContent = selected.client_name;
            const barHeight = 40;
            const canvas = document.getElementById('hourChart');
            canvas.height = selected.labels.length * barHeight;

            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, getConfig(currentType, selected));
        }

        function changeChartType(type) {
            currentType = type;
            renderChart();

            document.getElementById('barChart').classList.toggle('active', type === 'bar');
            document.getElementById('lineChart').classList.toggle('active', type === 'line');
        }

        function changeView(view) {
            currentView = view;
            renderChart();

            document.getElementById('weeklyBtn').classList.toggle('active', view === 'weekly');
            document.getElementById('monthlyBtn').classList.toggle('active', view === 'monthly');
        }

        projectSelect.addEventListener('change', function() {
            currentProject = this.value;
            renderChart();
        });

        renderChart();

        document.addEventListener("DOMContentLoaded", function() {
            const filterButton = document.getElementById("filter-button-id");
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.toString().length > 0) {
                filterButton.classList.add('filter-active');
            }
        });
    </script>
{% endblock %}
