{% extends "admin/base_site.html" %}

{% block content %}
    {% load static %}

    <style>
        #main{
            max-height: 80vh;
            min-width: 100vw;
            /* min-width: 100%; */
        }
        #hourChart{
            width: 100% !important;
        }
        #calendarbox1{
            left: 85% !important;
            top: 100px !important;
        }
        #nav-sidebar{
            display: none;
        }
        #toggle-nav-sidebar{
            display: none;
        }
        button {
            outline: none;
            background: white; /* Changed to white for unselected buttons */
            padding: 6px 10px;
            color: #417690; /* Match border color for text */
            border: 1px solid #417690; /* Border color matches original background */
            border-radius: 4px;
            font-weight: 400;
            transition: background 0.15s;
            cursor: pointer;
            margin-right: 6px;
        }
        button.active {
            background: #417690; /* Original default style for selected button */
            border-color: #417690;
            color: white; /* Ensure text is visible on dark background */
            font-weight: 600; /* Keep bolder text for active state */
        }
        .content{
            max-width: 100% !important;
        }
    </style>

    <script src="{% url 'js-catalog' %}"></script>
    <script src="{% static 'admin/js/core.js' %}"></script>
    <link rel="stylesheet" href="{% static 'admin/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'admin/css/widgets.css' %}">

    {% block content_title %}{% endblock %}

    <div style="display: flex; justify-content: space-between;">
        <div>
            <h1 id="chartTitle">{{ title }} ({{ chart.weekly.total_hour|floatformat:2 }})</h1>
        </div>

        <div>
            <button id="barChart" class="active" onclick="changeChartType('bar')">Bar</button>
            <button id="lineChart" onclick="changeChartType('line')">Line</button>
        </div>

        <!-- View Type Buttons -->
        <div>
            <button id="dailyBtn" onclick="updateChart('daily')">Daily</button>
            <button id="weeklyBtn" class="active" onclick="updateChart('weekly')">Weekly</button>
            <button id="monthlyBtn" onclick="updateChart('monthly')">Monthly</button>
        </div>

        <div>
            <form action="" method="get">
                {{ filter_form.media }}
                {{ filter_form }}
                <button type="submit" class="default">Filter</button>
            </form>
        </div>
    </div>

    <div id="main">
        <canvas id="hourChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
        const chartData = {{ chart|safe }};
        const ctx = document.getElementById('hourChart').getContext('2d');

        // Default configuration
        let currentView = 'weekly';
        let currentType = 'bar';

        function labelToDateRange(label, view) {
            /* 1. parse the displayed label (Mon-YYYY) */
            const months = {
                Jan:0, Feb:1, Mar:2, Apr:3, May:4, Jun:5,
                Jul:6, Aug:7, Sep:8, Oct:9, Nov:10, Dec:11
            };
            const [, m, y] = label.match(/(\w{3})-(\d{4})/);
            const startDate = new Date(Date.UTC(y, months[m], 1));   // 1-st of the month
            const startStr  = startDate.toISOString().slice(0,10);  // YYYY-MM-DD

            /* 2. compute the end of the period */
            let endDate, endStr;
            if (view === 'weekly') {
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);           // 7 days inclusive
            } else if (view == "daily"){
                endDate = startDate
            }
            else {  // monthly
                endDate = new Date(Date.UTC(y, months[m] + 1, 0, 23, 59, 59)); // last second of the month
            }
            endStr = endDate.toISOString().slice(0,10);

            return { start: startStr, end: endStr };
        }

        function getConfig(type, view) {
            return {
                type: type,
                data: {
                    labels: chartData[view].labels,
                    datasets: [{
                        employee_id: chartData.employee_id,
                        label: chartData[view].label,
                        data: chartData[view].data,
                        extraInfo: chartData[view].per_day_count,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgb(75, 192, 192)',
                            'rgb(255, 99, 132)',
                            'rgb(255, 206, 86)',
                            'rgb(54, 162, 235)',
                            'rgb(153, 102, 255)',
                            'rgb(255, 159, 64)'
                        ],
                        borderWidth: 1,
                        fill: type === 'line' ? true : false,
                        tension: type === 'line' ? 0.3 : 0 // smooth curve for line
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                const v = +value.toFixed(1)
                                return v;
                            },
                            font: {
                                weight: 'bold',
                                size: 16
                            },
                            color: function(context){
                                const index = context.dataIndex
                                const value = context.dataset.data[index]
                                const target_hour = chartData[view].target_hour | 0;
                                if (value>=target_hour) return "green";
                                else return "red";
                            },
                            listeners: {
                                click: function(context){
                                    
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const range = labelToDateRange(label, currentView);
                                    const employee_id = context.chart.data.datasets[0].employee_id;
                                    /* build the Django-admin query string */
                                    const url =
                                        `https://hr.mediusware.xyz/admin/project_management/dailyprojectupdate/` +
                                        `?employee__id__exact=${employee_id}&created_at__date__gte=${range.start}&created_at__date__lte=${range.end}`;
                                    
                                    window.open(url, '_blank');
                                },
                                enter: function(context) {
                                    // Change cursor to pointer when hovering over a datalabel
                                    context.chart.canvas.style.cursor = 'pointer';
                                },
                                leave: function(context) {
                                    // Revert cursor to default when leaving a datalabel
                                    context.chart.canvas.style.cursor = 'default';
                                }
                            }
                        },
                        
                        tooltip: {
                            enabled: true,
                             position: 'nearest', 
                            bodyFont: {
                                size: 16  // increase body font size
                            },
                            titleFont: {
                                size: 18  // optional: tooltip title font size
                            },
                            footerFont: {
                                size: 14  // optional: tooltip footer font size
                            },
                            displayColors: false,
                            backgroundColor: function(context) {
                                const value = parseFloat(context.tooltip.body[0].lines[0].split(" ")[2].replace(' ', ''));
                                const target_hour = chartData[view].target_hour | 0;
                                if(target_hour == 0){
                                    return '';
                                }
                                else if (value >= target_hour) return 'rgb(0, 64, 255, 1.00)'; // blue
                                else return 'rgba(200, 0, 0, 0.5)'; // red
                            },
                            callbacks: {
                                // label: function(context) {
                                //     return `${context.dataset.label} ${context.raw}`;
                                // },
                                footer: function(context) {
                                    function formatProjects(data) {
                                        return data.map(([name, value]) => `${name} : ${value}`);
                                    }
                                    function sumProjects(data) {
                                        const totals = {};
                                        // sum values for each project
                                        data.forEach(([project, value]) => {
                                            totals[project] = (totals[project] || 0) + value;
                                        });
                                        return Object.entries(totals);
                                    }

                                    const dataset = context[0].dataset;
                                    const index = context[0].dataIndex;
                                    if (dataset.extraInfo.length === 0) {
                                        return '';
                                    }
                                    else if (view === "daily"){
                                        return formatProjects(dataset.extraInfo[index]);
                                    }
                                    const extra = dataset.extraInfo[index];
                                    let formated_data = [
                                        `${extra.all_project_hour.length}(${extra.all_project_hour})`,
                                    ];
                                    formated_data = formated_data.concat(formatProjects(sumProjects(extra.project_by_project_hour)));
                                    return formated_data;
                                },
                            }
                        },
                        legend: {
                            labels: {
                                font: {
                                    size: 14  // legend font size
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                targetLine: {
                                    type: 'line',
                                    yMin: chartData[view].target_hour || 0,
                                    yMax: chartData[view].target_hour || 0,
                                    borderColor: 'red',
                                    borderWidth: 1,
                                    borderDash: [0, 0],
                                    // label: {
                                    //     enabled: true,
                                    //     content: `Target: ${chartData[view].target_hour || 0}`,
                                    //     position: 'center',
                                    //     backgroundColor: 'rgba(255, 182, 193, 0.9)',
                                    //     font: {
                                    //         size: 20,
                                    //     },
                                    //     padding: 6,
                                    // }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
                plugins: [ChartDataLabels]
            };
        }

        let myChart = new Chart(ctx, getConfig(currentType, currentView));

        function updateChart(view) {
            currentView = view;
            myChart.destroy();
            myChart = new Chart(ctx, getConfig(currentType, currentView));

            const buttons = {
                'daily': document.getElementById('dailyBtn'),
                'weekly': document.getElementById('weeklyBtn'),
                'monthly': document.getElementById('monthlyBtn')
            };
            Object.values(buttons).forEach(btn => btn.classList.remove('active'));
            buttons[view].classList.add('active');

            document.getElementById("chartTitle").innerText =
                "{{ title }} (" + chartData[view].total_hour.toFixed(2) + ")";
        }

        function changeChartType(type) {
            currentType = type;
            myChart.destroy();
            myChart = new Chart(ctx, getConfig(currentType, currentView));
            const buttons = {
                'bar': document.getElementById('barChart'),
                'line': document.getElementById('lineChart'),
            };
            Object.values(buttons).forEach(btn => btn.classList.remove('active'));
            buttons[currentType].classList.add('active');
        }
    </script>
{% endblock %}