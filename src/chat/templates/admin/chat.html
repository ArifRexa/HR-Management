{% extends 'admin/change_form.html' %}
{% load humanize %}

{% load i18n %}


{% block messages %}
    
{% endblock messages %}


{% block content_title %}

{% endblock content_title %}
    
    

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .chat-form{
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .colM{
        padding: 0!important;
    }
    .colM>h2{
        display: none;
    }
    .chat-container {
        height: 100vh;
        display: flex;
    }
    .chat-sidebar {
        background-color: #f8f9fa;
        width: 25%;
        border-right: 1px solid #ddd;
        overflow-y: auto;
    }
    .chat-main {
        width: 100%;
        height: 90vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .chat-header {
        padding: 1rem;
        background-color: #343a40;
        color: #fff;
    }
    .chat-messages {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
        background-color: #e9ecef;
    }
    .message {
        margin-bottom: 1rem;
    }
    .message .user-name {
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .message .text {
        padding: 0.5rem;
        background-color: #fff;
        border-radius: 10px;
        display: inline-block;
    }
    .chat-input {
        padding: 1rem;
        border-top: 1px solid #ddd;
    }
    .list-group{
        list-style: none;
    }
    .chat-message{
        border: none;
        z-index: 100;
    }
    .chat-message:hover{
        background-color: #a1a9ac;
    }
    .unread{
        background-color: #a1a9ac;
    }
    .chat-btn{
        border: none;
        background-color: var(--primary);
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        cursor: pointer;
        flex-basis: 5rem;
    }
    .vTextField{
        flex-grow: 2;
    }
    .attachment{
        cursor: pointer;
        display: inline-block;
    }
    .size-6 {
        width: 24px;
        height: 24px;
        color: #000; /* Change the icon color if needed */
        cursor: pointer;
    }

    input[type="file"] {
        display: none;
    }
    .attachment-container{
        display: flex;
        gap: 0.5rem;
        width: 600px;
        justify-content: end;
        flex-wrap: wrap;
    }
    .image-container{
        display: flex;
        gap: 0.5rem;
        width: 4rem;
        border-radius: 0.25rem;
        overflow: hidden;
        cursor: pointer;
    }
    .image-container img{
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
    }
    .right-align{
        display: flex;
        justify-content: flex-end;
        align-items: end;
        flex-direction: column;
    }
    .image-modal{
        display: none;
        position: absolute;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
        margin: 2% auto;
        padding: 20px;
        width: 80%; 
        max-height: 300px;
        border-radius: 8px;
    }
    .modal-content img{
        width: 100%;
        object-fit: cover;
        object-position: center;
        height: 80vh;

    }
    /* Close Button */
    .close {
        color: #aaa;
        text-align: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

</style>

<div class="container-fluid chat-container">
    <!-- Sidebar -->
    

    <!-- Main Chat Area -->
    <div class="chat-main">
        {% if chat %}
            <!-- Chat Header -->
            <div class="chat-header">
                <h5>{{chat.client.email}}</h5>
            </div>

            <!-- Chat Messages -->
            
            
                <div class="chat-messages" id="chat-messages">
                    <!-- Message from another user -->
                    {% for message in messages %}
                        <div class="message {% if request.user.employee.full_name == message.creator_name %}text-end right-align{% endif %}">
                            <div class="user-name">{{message.creator_name|default_if_none:"client"}}</div>
                            <div class="attachment-container">

                                {% if message.attachments %}

                                    {% for attachment in message.attachments.all %}

                                    {% if attachment.attachment %}
                                        
                                        {% if attachment.is_image %}
                                            <div class="image-container">
                                                <img src="{{attachment.attachment.url}}" alt="attachment">
                                            </div>
                                        {% else %}
                                            <a href="{{attachment.attachment.url}}" class="attachment" target="_blank">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                                                </svg>
                                            </a>
                                        {% endif %}
                                            
                                        
                                    {% endif %}
                                        
                                    {% endfor %}

                                {% endif %}
                            </div>
                            <div class="text bg-light">{{message.message}}</div>
                            {% now "SHORT_DATETIME_FORMAT" as timestamp %}
                            <div class="user-name">{{message.timestamp|naturaltime}}</div>
                        </div>
                    {% endfor %}
                    
                    <!-- Message from self -->
                    <!-- <div class="message text-end">
                        <div class="user-name">You</div>
                        <div class="text bg-primary text-white">I am good, thank you!</div>
                    </div> -->
                    <!-- Add more messages -->
                </div>
            
                

            <!-- Input Field -->
            <div class="chat-input" id="chat-form">
                <div id="file-name" class="file-name"></div>
                <form class="chat-form">
                    <div class="attachment">
                        <label for="file-upload">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13" />
                            </svg>
                        </label>
                        <input type="file" id="file-upload" style="display: none;" multiple>
                    </div>
                    <input type="text" class="vTextField me-2" placeholder="Type a message..." id="message-input">
                    <button class="chat-btn" type="submit" id="chat-message-input">Send</button>
                </form>
            </div>
            {{ chat.chat_id|json_script:"chat_id" }}
        {% endif %}
    </div>

</div>
<div class="image-modal" id="imageModal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modal-image-content">
            
        </div>
    </div>
</div>



<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>


    
    {% if chat %}
        <script>

            // image modal
            const imageModal = document.querySelector('#imageModal');
            const imageList = document.querySelectorAll('.image-container > img');
            const closeBtn = document.getElementsByClassName('close')[0];

            closeBtn.addEventListener('click', function() {
                imageModal.style.display = 'none';
            })
            
            imageList.forEach(image => {
                image.addEventListener('click', function(event) {
                const imgSrc = event.target.src
                const modalImage = imageModal.querySelector('#modal-image-content');
                modalImage.innerHTML = `<img src="${imgSrc}" alt="Selected Image">`;
                imageModal.style.display = 'block';
                
            })
            })

            // uploaded file name show
            const fileUploadInput = document.getElementById('file-upload');
            const fileNameDisplay = document.getElementById('file-name');
            let base64Files = [];

            // Add an event listener to the file input
            fileUploadInput.addEventListener('change', function() {
                // Get the selected file
                const files = fileUploadInput.files;
                
                
                // If a file was selected, display its name
                // if (file) {
                //     fileNameDisplay.textContent = `Selected file: ${file.name}`;
                // } else {
                //     fileNameDisplay.textContent = '';  // Clear if no file is selected
                // }
                for (let i = 0; i < files.length; i++) {
                    convertFileToBase64(files[i]);
                    fileNameDisplay.innerHTML += `<div>${i+1}. ${files[i].name}</div>`
                }
            });

            function convertFileToBase64(file) {
                const reader = new FileReader();
                
                // On successful reading, store the Base64 string and show a preview
                reader.onload = function(event) {
                    const base64String = event.target.result.split(',')[1];

                    // Add the Base64 encoded string to the array
                    base64Files.push({
                        fileName: file.name,
                        fileType: file.type,
                        base64: base64String
                    });

                    // Display file name and part of the Base64 string
                    // const fileItem = document.createElement('div');
                    // fileItem.textContent = `File ${file.name}: ${base64String.substring(0, 50)}...`; // Display part of the Base64 string for preview
                    // fileNamesDisplay.appendChild(fileItem);
                };
                
                // Read file as Data URL (which includes Base64)
                reader.readAsDataURL(file);
            }



            const WebSocketProtocal = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const WebSocketBaseUrl = WebSocketProtocal + window.location.host;
            
            // WebSocket connection
            const chatId = JSON.parse(document.getElementById('chat_id').textContent);
            const chatSocket = new WebSocket(`${WebSocketBaseUrl}/ws/chat/${chatId}/`);
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
            // convert date to human readable
            function timeSince(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);

                let interval = Math.floor(seconds / 31536000); // 1 year
                if (interval >= 1) return interval === 1 ? "1 year" : `${interval} years`;

                interval = Math.floor(seconds / 2592000); // 1 month
                if (interval >= 1) return interval === 1 ? "1 month" : `${interval} months`;

                interval = Math.floor(seconds / 86400); // 1 day
                if (interval >= 1) return interval === 1 ? "1 day" : `${interval} days`;

                interval = Math.floor(seconds / 3600); // 1 hour
                if (interval >= 1) return interval === 1 ? "1 hour" : `${interval} hours`;

                interval = Math.floor(seconds / 60); // 1 minute
                if (interval >= 1) return interval === 1 ? "1 minute" : `${interval} minutes`;

                return 'Now';
            }
        
            // Event listener for receiving messages
            chatSocket.onmessage = function(e) {
                console.log("on message", e.data)
                const data = JSON.parse(e.data);
                
                let username = data.agent? data.agent : 'client';
                console.log(data)
                let cl = data.agent? ' text-end' : '';
                // const date = new Date(data.timestamp);
                // let timestamp = date.getHours() + ':' + date.getMinutes()
                // console.log("timestamp", d)
                
                
                const newMessage = `
                    <div class="message${cl}">
                        <div class="user-name">${username}</div>

                        <div class="text bg-light">${data.message}</div>
                        <div class="">${timeSince(data.timestamp)}</div>
                    </div>
                `;
                
                chatMessages.innerHTML += newMessage;
                chatMessages.scrollTop = chatMessages.scrollHeight;  // Auto-scroll to the latest message
            };
        
            // Handle errors
            chatSocket.onerror = function(e) {
                console.error('WebSocket error:', e);
            };
            chatSocket.onopen = function(e){
                console.log("connected....", e)
            }
        
            // Send message when the form is submitted
            const chatForm = document.getElementById('chat-form');
            chatForm.onsubmit = function(e) {
                e.preventDefault();
                console.log("submit")
                const files = fileUploadInput.files;
                const messageInput = document.getElementById('message-input');
                const message = messageInput.value;
        
                // Send the message through WebSocket
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'username': "{{ request.user.username }}",  // Replace with actual username from your app
                    'type': 'chat_message',
                    "attachments": base64Files
                }));
        
                // Clear the input field
                messageInput.value = '';
                fileNameDisplay.innerHTML = "";
            };
            
        </script>
    {% endif %}
        
{% endblock content %}
    
